<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GST Registration - Compliance First</title>
    <link rel="stylesheet" href="style.css" />
    <style>
        /* Enhanced Loading Bar (mirrors 1.html) */
        .loading-wrapper { display: none; margin: 10px 0 16px 0; }
        .loading-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; color: #2e7d32; font-weight: 600; font-size: 13px; letter-spacing: 0.2px; }
        .loading-track { position: relative; width: 100%; height: 8px; background: rgba(76, 175, 80, 0.15); border-radius: 999px; overflow: hidden; box-shadow: inset 0 0 0 1px rgba(46, 125, 50, 0.12); }
        .loading-bar { position: absolute; left: 0; top: 0; bottom: 0; width: 0%; border-radius: 999px; background-image: linear-gradient(90deg, #43a047, #66bb6a); box-shadow: 0 0 12px rgba(102, 187, 106, 0.6); transition: width 0.25s ease; }
        .loading-bar::after { content: ""; position: absolute; inset: 0; background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.25) 0, rgba(255,255,255,0.25) 10px, transparent 10px, transparent 20px); background-size: 28px 28px; animation: barberpole 0.9s linear infinite; border-radius: inherit; }
        @keyframes barberpole { 0% { background-position: 0 0; } 100% { background-position: 28px 0; } }
        .director-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-bottom: 10px;
        }
        
    .dual-dropdown select {
      flex: 1;
}
    </style>
</head>
<body>
    <div class="background"></div>
    <a href="#" class="home-btn" onclick="event.preventDefault(); history.back();">← BACK</a>
    <header>
        <img src="logo.png" alt="Logo" class="logo"/>
        <h1 class="company-name">GST Minutes</h1>
    </header>

    <main>
        <div id="fetchSection" class="fetch-container">
            <label for="company">Enter Company Name:</label>
            <input type="text" id="company" class="uppercase-input" placeholder="e.g. Compliance First Pvt. Ltd" />
            <div class="fetch-buttons-group" style="margin-top:10px;">
                <button id="parseBtn1" onclick="parseResponse()">MCA Fetch</button>
                <button id="parseBtn" onclick="parseResponse()">Falcon Fetch</button>
            </div>
            <div id="loadingWrapper" class="loading-wrapper">
                <div class="loading-header">
                    <span id="loadingLabel">Fetching company data…</span>
                    <span id="loadingPercent">0%</span>
                </div>
                <div class="loading-track">
                    <div id="loadingBar" class="loading-bar"></div>
                </div>
            </div>
            <div id="parsedDetails" style="margin-top: 0px;"></div>
        </div>

        <div id="directorsSection" style="display: none;"></div>
        <div class="two-col" id="MEETING-AUDITOR-ROW" style="display: none;">
            <div id="MEETING-BOX" class="fetch-container"  style="display: none;"></div>
            <div id="CA-BOX" class="fetch-container" style="display: none;"></div>
        </div>
        <div class="button-center" id="convertContainer" style="display: none;">
            <button id="convert" disabled>Convert to Word</button>
        </div>

    </main>

    <script>
        // Auto-uppercase utility for inputs with class 'uppercase-input'
        function addUppercaseListeners(root = document) {
            const fields = root.querySelectorAll('.uppercase-input');
            fields.forEach((field) => {
                const toUpper = () => {
                    if (typeof field.value === 'string') field.value = field.value.toUpperCase();
                };
                field.removeEventListener('input', toUpper);
                field.addEventListener('input', toUpper);
                field.removeEventListener('blur', toUpper);
                field.addEventListener('blur', toUpper);
            });
        }
        document.addEventListener('DOMContentLoaded', function(){ addUppercaseListeners(document); });
        let directorLabelText = "Director";

        // ========================= HELPER FUNCTIONS =========================

        // Function to update all dropdowns with current members
        function updateMemberDropdowns() {
            const members = [];
            
            // Get all directors with their designations
            document.querySelectorAll(".director-box1").forEach((box, i) => {
                const nameField = box.querySelector(`#PERSON_${i+1}`);
                const designationField = box.querySelector(`#PERSON_${i+1}_D`);
                if (nameField && nameField.value.trim()) {
                    const name = nameField.value.trim();
                    const designation = designationField?.value.trim() || "";
                    members.push({
                        name: name,
                        display: designation ? `${name} (${designation})` : name,
                        plainName: name
                    });
                }
            });
            
            // Exclude auditor from meeting dropdown member list by request
            
            // Update all dropdowns
            const dropdowns = ['CHAIRMAN', 'RESOLVED_BY_1', 'RESOLVED_BY_2', 'VOTE_THANKS'];
            dropdowns.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                if (dropdown) {
                    const currentValue = dropdown.value;
                    dropdown.innerHTML = '<option value="">-- Select Member --</option>';
                    const usePlainName = ['CHAIRMAN', 'RESOLVED_BY_1', 'RESOLVED_BY_2'].includes(dropdownId);
                    members.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member.name;
                        option.textContent =usePlainName ? member.plainName : member.display;
                        dropdown.appendChild(option);
                    });
                    // Restore previous selection if it still exists
                    const memberNames = members.map(m => m.name);
                    if (memberNames.includes(currentValue)) {
                        dropdown.value = currentValue;
                    }
                }
            });
        }

        // Function to update the auditor field value
        function updateAuditorField() {
            const firmValue = document.getElementById("FIRM")?.value || "";
            const frnValue = document.getElementById("FRN")?.value || "";
            const nameValue = document.getElementById("NAME")?.value || "";
            const desValue = document.getElementById("DES")?.value || "";
            const mrnValue = document.getElementById("MRN")?.value || "";
            const placeValue = document.getElementById("PLACE")?.value || "";

            const auditorField = document.getElementById("AUDITOR");
            if (auditorField) {
                auditorField.value = `${firmValue}, Chartered Accountants, FRN:${frnValue}, ${nameValue}${desValue}, having MRN:${mrnValue},${placeValue}`;
            }
            
            // Update dropdowns when auditor name changes
            updateMemberDropdowns();
        }

        // Function to format a date into a "Deed" format
        function formatDateForDeed(dateString) {
            const [day, month, year] = dateString.split('-').map(Number);
            const date = new Date(year, month - 1, day);

            if (isNaN(date.getTime())) {
                return "Invalid Date";
            }

            const daySuffix = (d) => {
                if (d > 3 && d < 21) return 'th';
                switch (d % 10) {
                    case 1: return 'st';
                    case 2: return 'nd';
                    case 3: return 'rd';
                    default: return 'th';
                }
            };

            const monthNames = [
                "January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"
            ];

            return `${date.getDate()}${daySuffix(date.getDate())} day of ${monthNames[date.getMonth()]}, ${date.getFullYear()}`;
        }
        
        // Function to update distinctive numbers for all directors
        function updateDistinctiveNumbers() {
            const directorBoxes = document.querySelectorAll(".director-box1");
            let distinctiveFrom = 1;

            directorBoxes.forEach((box) => {
                const equitySharesInput = box.querySelector('[id^="EQUITY_SHARES_"]');
                const distinctiveFromInput = box.querySelector('[id^="FROM_"]');
                const distinctiveToInput = box.querySelector('[id^="TO_"]');
                
                const shares = parseInt(equitySharesInput.value, 10);
                
                if (!isNaN(shares) && shares > 0) {
                    const distinctiveTo = distinctiveFrom + shares - 1;
                    distinctiveFromInput.value = distinctiveFrom;
                    distinctiveToInput.value = distinctiveTo;
                    distinctiveFrom = distinctiveTo + 1;
                } else {
                    distinctiveFromInput.value = '';
                    distinctiveToInput.value = '';
                }
            });
            checkRequiredFields();
        }

        // Function to renumber all director boxes and sync IDs like 1.html
        function renumberDirectors() {
            const boxes = document.querySelectorAll('.director-box1');
            boxes.forEach((box, i) => {
                const newIndex = i + 1;
                const oldIndex = box.getAttribute('data-index');
                if (String(oldIndex) === String(newIndex)) return;
                box.setAttribute('data-index', newIndex);
                const header = box.querySelector('h4');
                if (header) header.textContent = `${directorLabelText} ${newIndex}`;
                const elementsWithOldId = box.querySelectorAll(`[id*='_${oldIndex}']`);
                elementsWithOldId.forEach((el) => {
                    el.id = el.id.replace(new RegExp(`_${oldIndex}$`), `_${newIndex}`);
                });
                const removeBtn = box.querySelector('.remove-btn');
                if (removeBtn) removeBtn.setAttribute('onclick', `removeMemberField(${newIndex})`);
            });
            updateDistinctiveNumbers();
        }

        // Function to set up all event listeners after the DOM is rendered
        function setupEventListeners() {
            // Event listener for the main date field
            const dateInput = document.getElementById('DATE');
            if (dateInput) {
                dateInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 2 && value.length <= 4) {
                        value = value.slice(0, 2) + '-' + value.slice(2);
                    } else if (value.length > 4) {
                        value = value.slice(0, 2) + '-' + value.slice(2, 4) + '-' + value.slice(4, 8);
                    }
                    e.target.value = value;
                    
                    const parts = value.split('-');
                    const dayField = document.getElementById('DAY');
                    const deedDateField = document.getElementById('DEED_DATE');
                    
                    if (dayField && deedDateField) {
                        dayField.value = '';
                        deedDateField.value = '';
                        e.target.style.backgroundColor = '';
                    
                        if (parts.length === 3 && parts[0].length === 2 && parts[1].length === 2 && parts[2].length === 4) {
                            const day = parseInt(parts[0], 10);
                            const month = parseInt(parts[1], 10);
                            const year = parseInt(parts[2], 10);
                            
                            if (month > 12 || day > 31 || year < 1900 || year > 2100) {
                                e.target.style.backgroundColor = '#66ac4c40';
                                return;
                            }
                            
                            const dateObj = new Date(year, month - 1, day);
                            if (!isNaN(dateObj.getTime())) {
                                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                                dayField.value = days[dateObj.getDay()];
                                deedDateField.value = formatDateForDeed(value);
                            }
                        }
                    }
                });
            }

            // Event listeners for the auditor fields to automatically update
            const auditorFields = ["FIRM", "FRN", "NAME", "DES", "MRN", "PLACE"];
            auditorFields.forEach(id => {
                const field = document.getElementById(id);
                if (field) {
                    field.addEventListener('input', updateAuditorField);
                }
            });
            
            // Event listeners for equity shares to update distinctive numbers
            document.querySelectorAll('[id^="EQUITY_SHARES_"]').forEach(field => {
                field.addEventListener('input', updateDistinctiveNumbers);
            });
        }

        // Function to check if all required fields are filled
        function checkRequiredFields() {
            const convertButton = document.getElementById("convert");
            if (!convertButton) return;
            const requiredFields = document.querySelectorAll("#parsedDetails [required], #directorsSection [required]");
            let allFilled = true;
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    allFilled = false;
                }
            });
            convertButton.disabled = !allFilled;
        }

        // Helper to get next index like 1.html
        function getNextMemberIndex() {
            const boxes = document.querySelectorAll('.director-box1');
            let maxIndex = 0;
            boxes.forEach((box) => {
                const idx = parseInt(box.getAttribute('data-index'));
                if (idx > maxIndex) maxIndex = idx;
            });
            return maxIndex + 1;
        }

        // Create a member box HTML (mirrors 1.html style)
        function createMemberBoxHTML(index, data = {}, isCompanyWithCIN = true) {
            const label = isCompanyWithCIN ? 'Director' : 'Partner';
            return `
                <div class="director-box1" style="margin-top: 10px;" data-index="${index}">
                    <div class="box-header">
                        <h4>${label} ${index}</h4>
                        <button class="remove-btn" onclick="removeMemberField(${index})">Remove</button>
                    </div>
                    <div class="editable-row">
                        <label>NAME:</label>
                        <input type="text" id="PERSON_${index}" class="editable-field" value="${data.name || ''}" required>
                    </div>
                    <div class="editable-row">
                        <label>Designation:</label>
                        <input type="text" id="PERSON_${index}_D" class="editable-field" value="${data.designation || ''}">
                    </div>
                    <div class="editable-row">
                        <label>DIN:</label>
                        <input type="text" id="PERSON_${index}_DIN" class="editable-field" value="${data.din || ''}" required>
                    </div>
                    <div class="editable-row">
                        <label>No.of Equity Shares:</label>
                        <input type="text" id="EQUITY_SHARES_${index}" class="editable-field" placeholder="eg: 1000" required>
                    </div>
                    <div class="editable-row">
                        <label>Folio No:</label>
                        <input type="text" id="FOLIO_${index}" class="editable-field" placeholder="eg: 001" required>
                    </div>
                    <div class="editable-row">
                        <label>Certificate No:</label>
                        <input type="text" id="CERTI_NO_${index}" class="editable-field" placeholder="eg: 001" required>
                    </div>
                    <div class="editable-row">
                        <label>Distinctive No.:</label>
                        <input type="text" id="FROM_${index}" class="editable-field distinctive-no" placeholder="From" readonly>
                        <input type="text" id="TO_${index}" class="editable-field distinctive-no" placeholder="To" readonly>
                    </div>
                </div>
            `;
        }

        // Attach listeners to a member box like 1.html
        function attachMemberFieldListeners(index) {
            const box = document.querySelector(`.director-box1[data-index="${index}"]`);
            if (!box) return;
            const equityField = box.querySelector(`[id="EQUITY_SHARES_${index}"]`);
            if (equityField) equityField.addEventListener('input', updateDistinctiveNumbers);
            const nameField = box.querySelector(`[id="PERSON_${index}"]`);
            if (nameField) nameField.addEventListener('input', updateMemberDropdowns);
            const desField = box.querySelector(`[id="PERSON_${index}_D"]`);
            if (desField) desField.addEventListener('input', updateMemberDropdowns);
            box.querySelectorAll('input, textarea').forEach((field) => {
                field.addEventListener('input', checkRequiredFields);
            });
        }

        // Add new member field (single add button)
        function addMemberField() {
            const container = document.getElementById('directorFieldsContainer');
            const newIndex = getNextMemberIndex();
            const temp = document.createElement('div');
            const isCIN = document.getElementById('COMPANY_ID')?.previousElementSibling?.textContent?.includes('CIN');
            temp.innerHTML = createMemberBoxHTML(newIndex, {}, !!isCIN).trim();
            const newBox = temp.firstChild;
            container.appendChild(newBox);
            attachMemberFieldListeners(newIndex);
            renumberDirectors();
            updateMemberDropdowns();
            updateDistinctiveNumbers();
            checkRequiredFields();
        }

        // Remove member field with minimum 1 remaining
        function removeMemberField(index) {
            const boxes = document.querySelectorAll('.director-box1');
            if (boxes.length <= 1) {
                alert('At least one member must remain!');
                return;
            }
            const box = document.querySelector(`.director-box1[data-index="${index}"]`);
            if (box) box.remove();
            renumberDirectors();
            updateMemberDropdowns();
            updateDistinctiveNumbers();
            checkRequiredFields();
        }

        // ========================= MAIN FUNCTIONS =========================

        function generatePrompt() {
            const company = document.getElementById("company").value.trim();
            if (!company) return;
            const prompt = `Fetch based on public sources like MCA Portal, ZaubaCorp, InstaFinancials, The Company Check, and other verified Indian company/LLP databases.

Give ONLY the following EXACT information for the company named "${company}" in the following format:

Company Name: [Company Name]
[CIN or LLPIN Label]: [CIN or LLPIN]
Date of Incorporation: [DD Month YYYY]
Company Type: [Private Limited/LLP/etc]
Registered Office Address: [Address]

[Directors or Partners Label] :
NAME: [Name], DESIGNATION: [Designation], DIN: [DIN]

Rules for search and output:
1. Conduct an EXTREME, deep, and exhaustive search across at least three verified public sources.
2. Cross-verify all details from a minimum of two sources to confirm accuracy before generating the final output.
3. The response MUST include all specified fields.
4. If the company is an LLP, provide the LLPIN. If it is a Private Limited company, provide the CIN. Do not show both. The label should dynamically display as either "CIN:" or "LLPIN:".
5. The label should dynamically display as either "Directors:" or "Partners:".
6. All DIN numbers for all directors MUST be fetched and displayed. Do not use placeholders like 'Not Available'. The data will be available in the open sources. If a DIN is genuinely not found after an exhaustive search, explicitly state it for that specific director, but only as a last resort after all other avenues have been exhausted.
7. The date of incorporation and registered address must be complete and accurate.
8. Double-check all details one last time before outputting the final result to ensure no information is missing or incorrect.
`;
            
            navigator.clipboard.writeText(prompt).then(() => {
                window.open("https://gemini.google.com/app", "_blank");
                document.querySelector("label[for='company']").style.display = "none";
                document.getElementById("company").style.display = "none";
                document.querySelector("#fetchSection button").style.display = "none";
                document.getElementById("pasteParseBtn").style.display = "inline-block";
                document.getElementById("fetchSection").scrollIntoView({ behavior: "smooth" });
            });
        }

        async function parseResponse() {
            const companyInput = document.getElementById("company");
            const company = (companyInput.value || "").trim();
            if (!company) return;

            const loadingWrapper = document.getElementById("loadingWrapper");
            const loadingBar = document.getElementById("loadingBar");
            const loadingPercent = document.getElementById("loadingPercent");
            const loadingLabel = document.getElementById("loadingLabel");
            loadingWrapper.style.display = "block";
            loadingBar.style.width = "0%";
            if (loadingPercent) loadingPercent.textContent = "0%";
            if (loadingLabel) loadingLabel.textContent = "Fetching company data…";

            // Smooth animated progress
            let progress = 0;
            let rafId = null;
            const animate = () => {
                progress += (95 - progress) * 0.05;
                if (progress > 95) progress = 95;
                loadingBar.style.width = progress + "%";
                if (loadingPercent) loadingPercent.textContent = Math.round(progress) + "%";
                rafId = requestAnimationFrame(animate);
            };
            rafId = requestAnimationFrame(animate);

            try {
                const res = await fetch(`/api/getdata?name=${encodeURIComponent(company)}`);
                const data = await res.json();
                const d = data?.data || {};
                const haveCIN = !!d.CIN;
                const companyIDLabel = haveCIN ? "CIN" : "LLPIN";
                const companyID = haveCIN ? (d.CIN || "") : (d.LLPIN || "");
                const dateOfIncorporation = d["Date of Incorporation"] || "";
                const companyType = d.Activity || "";
                const address = d.Address || "";
                const directors = Array.isArray(d.Directors) && d.Directors.length ? d.Directors.map(x => ({
                    name: x.Name || "",
                    designation: x.Designation || "",
                    din: x.DIN || ""
                })) : [{},{}];

                // Stop loader and finalize
                if (rafId) cancelAnimationFrame(rafId);
                loadingBar.style.width = "100%";
                if (loadingPercent) loadingPercent.textContent = "100%";
                if (loadingLabel) loadingLabel.textContent = "Finalizing…";
                setTimeout(() => {
                    loadingWrapper.style.display = "none";
                    loadingBar.style.width = "0%";
                    if (loadingPercent) loadingPercent.textContent = "0%";
                    if (loadingLabel) loadingLabel.textContent = "Fetching company data…";
                }, 300);

                // Render details (reuse existing clipboard renderer template)
                document.getElementById("parsedDetails").innerHTML = `
                        <h2>Parsed Company Details:</h2>
                        <div class="editable-row">
                            <label>Company Name:</label>
                            <input type="text" id="COMPANY_NAME" class="editable-field" value="${company || 'Not found'}">
                        </div>
                        <div class="editable-row">
                            <label>${companyIDLabel}:</label>
                            <input type="text" id="COMPANY_ID" class="editable-field" value="${companyID || 'Not found'}">
                        </div>
                        <div class="editable-row">
                            <label>Date of Incorporation:</label>
                            <input type="text" id="DATE_OF_INCORPORATION" class="editable-field" value="${dateOfIncorporation || 'Not found'}">
                        </div>
                        <div class="editable-row">
                            <label>Company Type:</label>
                            <input type="text" id="COMPANY_TYPE" class="editable-field" value="${companyType || 'Not found'}">
                        </div>
                        <div class="editable-row">
                            <label>ADDRESS:</label>
                            <textarea id="ADDRESS" class="editable-field" rows="3">${address || 'Not found'}</textarea>
                        </div>
                        <div class="editable-row">
                            <label>Email:</label>
                            <input type="email" id="EMAIL" class="editable-field" placeholder="Enter email" required>
                        </div>
                        <div class="editable-row">
                            <label>Phone Num:</label>
                            <input type="text" id="PHONE_1" class="editable-field" placeholder="Enter Phone Num" required>
                        </div>
                        <div class="editable-row">
                            <label>PAN:</label>
                            <input type="text" id="PAN" class="editable-field" placeholder="Enter PAN" required>
                        </div>
                        <div class="editable-row">
                            <label>TAN:</label>
                            <input type="text" id="TAN" class="editable-field" placeholder="Enter TAN" required>
                        </div>
                        <div class="editable-row">
                            <label>PLACE:</label>
                            <input type="text" id="PLACE" class="editable-field" placeholder="eg: Salem" required>
                        </div>
                        <div class="editable-row">
                            <label>DATE:</label>
                            <input type="text" id="DATE" class="editable-field" placeholder="DD-MM-YYYY" maxlength="10" required>
                            <input type="text" id="DEED_DATE" class="editable-field" placeholder="06th day of January, 2025" readonly hidden>
                            <input type="text" id="DAY" class="editable-field" placeholder="Sunday" required hidden>
                        </div>
                        <div class="editable-row">
                            <label>Rupees of Each Share:</label>
                            <input type="text" id="SHAR-EACH" class="editable-field" placeholder="eg: 100" required>
                        </div>
                        <div class="editable-row">
                            <label>BANK:</label>
                            <input type="text" id="BANK" class="editable-field" placeholder="eg: Axis Bank" required>
                        </div>
                        <div class="editable-row">
                            <label>BRANCH:</label>
                            <input type="text" id="BRANCH" class="editable-field" placeholder="eg: Salem Main" required>
                        </div>
                    `;

                document.getElementById("directorsSection").innerHTML = `
                    <div class="director-controls">
                        <h2>${haveCIN ? 'Director' : 'Partner'} Details</h2>
                        <button onclick="addMemberField()">+ Add ${haveCIN ? 'Director' : 'Partner'}</button>
                    </div>
                    <div class="fetch-container1" id="directorFieldsContainer">
                        ${directors.map((d, i) => createMemberBoxHTML(i + 1, d, haveCIN)).join('')}
                    </div>
                `;

                // Render MEETING-BOX content
                const meetingBox = document.getElementById("MEETING-BOX");
                if (meetingBox) {
                    meetingBox.innerHTML = `
                        <h2>MEETING DETAILS:</h2>
                        <div class="editable-row">
                            <label>Chairman of the Meeting:</label>
                            <select id="CHAIRMAN" class="editable-field" required>
                                <option value="">-- Select Member --</option>
                            </select>
                        </div>
                        <div class="editable-row dual-row">
                            <label>Resolved That:</label>
                            <div class="dual-dropdown">
                                <select id="RESOLVED_BY_1" class="editable-field" required>
                                    <option value="">-- Select Member 1 --</option>
                                </select>
                                <select id="RESOLVED_BY_2" class="editable-field" required>
                                    <option value="">-- Select Member 2 --</option>
                                </select>
                            </div>
                        </div>
                        <div class="editable-row">
                            <label>Vote of Thanks:</label>
                            <select id="VOTE_THANKS" class="editable-field" required>
                                <option value="">-- Select Member --</option>
                            </select>
                        </div>
                    `;
                }

                // Render CA-BOX (Auditor) content
                const caBox = document.getElementById("CA-BOX");
                if (caBox) {
                    caBox.innerHTML = `
                        <h2>AUDITOR:</h2>
                        <div class="editable-row">
                            <label>Firm name:</label>
                            <input type="text" id="FIRM" class="editable-field" value="T N R AND COMPANY," required>
                        </div>
                        <div class="editable-row">
                            <label>Name:</label>
                            <input type="text" id="NAME" class="editable-field" value="Mr. CA VIJAYARAJ, F.C.A.," required>
                        </div>
                        <div class="editable-row">
                            <label>Designation:</label>
                            <input type="text" id="DES" class="editable-field" value="Partner" required>
                        </div>
                        <div class="editable-row">
                            <label>FRN:</label>
                            <input type="text" id="FRN" class="editable-field" value="016669S" required>
                        </div>
                        <div class="editable-row">
                            <label>MRN:</label>
                            <input type="text" id="MRN" class="editable-field" value="245110" required>
                        </div>
                        <div class="editable-row">
                            <label>Place:</label>
                            <input type="text" id="PLACE" class="editable-field" value="Salem" required>
                        </div>
                        <div class="editable-row" style="margin-top: 20px;">
                            <label for="AUDITOR">Generated Auditor Details:</label>
                            <input type="text" id="AUDITOR" class="editable-field" readonly>
                        </div>
                    `;
                }

                // Show hidden sections (two-column row visible)
                document.getElementById("directorsSection").style.display = "block";
                document.getElementById("MEETING-AUDITOR-ROW").style.display = "flex";
                document.getElementById("MEETING-BOX").style.display = "block";
                document.getElementById("CA-BOX").style.display = "block";
                const convertWrap = document.getElementById("convertContainer");
                if (convertWrap) convertWrap.style.display = "flex";

                // Set up listeners and initial computations
                setupEventListeners();
                Array.from(document.querySelectorAll('.director-box1')).forEach((box) => {
                    const idx = parseInt(box.getAttribute('data-index'));
                    attachMemberFieldListeners(idx);
                });
                renumberDirectors();
                updateDistinctiveNumbers();
                checkRequiredFields();
                updateAuditorField();
                updateMemberDropdowns();
                const convertButton = document.getElementById("convert");
                if (convertButton) {
                    convertButton.style.display = "block";
                    convertButton.addEventListener("click", handleConvertClick);
                }

            } catch (err) {
                console.error(err);
                // Stop loader on error
                if (rafId) cancelAnimationFrame(rafId);
                loadingWrapper.style.display = "none";
                loadingBar.style.width = "0%";
                if (loadingPercent) loadingPercent.textContent = "0%";
                if (loadingLabel) loadingLabel.textContent = "Fetching company data…";
            }
        }
        
        async function handleConvertClick() {
            const directors = [];
            document.querySelectorAll(".director-box1").forEach((box, i) => {
                const idx = i + 1;
                directors.push({
                    name: document.getElementById(`PERSON_${idx}`)?.value || "",
                    designation: document.getElementById(`PERSON_${idx}_D`)?.value || "",
                    din: document.getElementById(`PERSON_${idx}_DIN`)?.value || "",
                    equityShares: document.getElementById(`EQUITY_SHARES_${idx}`)?.value || "",
                    folioNo: document.getElementById(`FOLIO_${idx}`)?.value || "",
                    certNo: document.getElementById(`CERTI_NO_${idx}`)?.value || "",
                    From: document.getElementById(`FROM_${idx}`)?.value || "",
                    To: document.getElementById(`TO_${idx}`)?.value || ""
                });
            });

            const replacements = {
                page: "GST Minutes",
                COMPANY_NAME: document.getElementById("COMPANY_NAME").value,
                COMPANY_ID: document.getElementById("COMPANY_ID").value,
                DATE_OF_INCORPORATION: document.getElementById("DATE_OF_INCORPORATION").value,
                ADDRESS: document.getElementById("ADDRESS").value,
                EMAIL: document.getElementById("EMAIL").value,
                PHONE_1: document.getElementById("PHONE_1").value,
                PAN: document.getElementById("PAN").value,
                TAN: document.getElementById("TAN").value,
                DATE: document.getElementById("DATE").value,
                SHARE_EACH: document.getElementById("SHAR-EACH").value,
                PLACE: document.getElementById("PLACE").value,
                AUDITOR: document.getElementById("AUDITOR").value,
                CHAIRMAN: document.getElementById("CHAIRMAN").value,
                RESOLVED_BY_1: document.getElementById("RESOLVED_BY_1").value,
                RESOLVED_BY_2: document.getElementById("RESOLVED_BY_2").value,
                VOTE_THANKS: document.getElementById("VOTE_THANKS").value,
                directors,
                DEED_DATE: document.getElementById("DEED_DATE").value,
                DAY: document.getElementById("DAY").value,
                BANK: document.getElementById("BANK").value,
                BRANCH: document.getElementById("BRANCH").value,
                CHAIRMAN: document.getElementById("CHAIRMAN").value,
                R1: document.getElementById("RESOLVED_BY_1").value,
                R2: document.getElementById("RESOLVED_BY_2").value,
                VOTE: document.getElementById("VOTE_THANKS").value,
            };

            try {
                const res = await fetch("/generate", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(replacements)
                });

                if (!res.ok) {
                    console.error("Server error:", res.statusText);
                    return;
                }
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `${document.getElementById("COMPANY_NAME").value} Minutes.docx`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
            } catch (err) {
                console.error("Fetch error:", err);
            }
        }
    </script>
     <a href="https://www.on-tym.solutions/" target="_blank" rel="noopener noreferrer">
       <img src="/Ontym.png" alt="On-tym Logo" class="fixed-bottom-logo" />
     </a>
</body>
</html>