<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GST Registration - Compliance First</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .editable-row {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="background"></div>
  <a href="#" class="home-btn" onclick="event.preventDefault(); history.back();">← BACK</a>
  <header>
    <img src="logo.png" alt="Logo" class="logo"/>
    <h1 class="company-name">GST Resolution</h1>
  </header>

  <main>
    <div id="fetchSection" class="fetch-container">
      <label for="company">Enter Company Name:</label>
      <input type="text" id="company" class="uppercase-input" placeholder="e.g. Compliance First Pvt. Ltd" />
      <div class="fetch-buttons-group" style="margin-top:10px;">
        <button id="parseBtn1" onclick="parseResponse()">MCA Fetch</button>
        <button id="parseBtn" onclick="parseResponse()">Falcon Fetch</button>
      </div>
      <div id="loadingWrapper" class="loading-wrapper" style="display:none; margin-top:10px;">
        <div class="loading-header" style="display:flex;justify-content:space-between;align-items:center;color:#2e7d32;font-weight:600;font-size:13px;">
          <span id="loadingLabel">Fetching company data…</span>
          <span id="loadingPercent">0%</span>
        </div>
        <div class="loading-track" style="position:relative;width:100%;height:8px;background:rgba(76,175,80,0.15);border-radius:999px;overflow:hidden;box-shadow:inset 0 0 0 1px rgba(46,125,50,0.12);">
          <div id="loadingBar" class="loading-bar" style="position:absolute;left:0;top:0;bottom:0;width:0%;border-radius:999px;background-image:linear-gradient(90deg,#43a047,#66bb6a);"></div>
        </div>
      </div>
      <div id="parsedDetails" style="margin-top: 0px;"></div>
    </div>
  </main>

  <script>
    // Auto-uppercase utility for inputs with class 'uppercase-input'
    function addUppercaseListeners(root = document) {
      const fields = root.querySelectorAll('.uppercase-input');
      fields.forEach((field) => {
        const toUpper = () => {
          if (typeof field.value === 'string') field.value = field.value.toUpperCase();
        };
        field.removeEventListener('input', toUpper);
        field.addEventListener('input', toUpper);
        field.removeEventListener('blur', toUpper);
        field.addEventListener('blur', toUpper);
      });
    }
    document.addEventListener('DOMContentLoaded', function(){ addUppercaseListeners(document); });
    async function parseResponse() {
      const companyInput = document.getElementById("company");
      const company = (companyInput.value || "").trim();
      if (!company) return;

      const loadingWrapper = document.getElementById("loadingWrapper");
      const loadingBar = document.getElementById("loadingBar");
      const loadingPercent = document.getElementById("loadingPercent");
      const loadingLabel = document.getElementById("loadingLabel");
      loadingWrapper.style.display = "block";
      loadingBar.style.width = "0%";
      if (loadingPercent) loadingPercent.textContent = "0%";
      if (loadingLabel) loadingLabel.textContent = "Fetching company data…";

      let progress = 0;
      let rafId = null;
      const animate = () => {
        progress += (95 - progress) * 0.05;
        if (progress > 95) progress = 95;
        loadingBar.style.width = progress + "%";
        if (loadingPercent) loadingPercent.textContent = Math.round(progress) + "%";
        rafId = requestAnimationFrame(animate);
      };
      rafId = requestAnimationFrame(animate);

      try {
        const res = await fetch(`/api/getdata?name=${encodeURIComponent(company)}`);
        const data = await res.json();
        const d = data?.data || {};
        const haveCIN = !!d.CIN;
        const companyIDLabel = haveCIN ? "CIN" : "LLPIN";
        const companyID = haveCIN ? (d.CIN || "") : (d.LLPIN || "");
        const dateOfIncorporation = d["Date of Incorporation"] || "";
        const companyType = d.Activity || "";
        const address = d.Address || "";
        const directors = Array.isArray(d.Directors) && d.Directors.length ? d.Directors.map(x => ({
          name: x.Name || "",
          designation: x.Designation || "",
          din: x.DIN || ""
        })) : [{}, {}];

        if (rafId) cancelAnimationFrame(rafId);
        loadingBar.style.width = "100%";
        if (loadingPercent) loadingPercent.textContent = "100%";
        if (loadingLabel) loadingLabel.textContent = "Finalizing…";
        setTimeout(() => {
          loadingWrapper.style.display = "none";
          loadingBar.style.width = "0%";
          if (loadingPercent) loadingPercent.textContent = "0%";
          if (loadingLabel) loadingLabel.textContent = "Fetching company data…";
        }, 300);

        const parsedData = {
          companyName: company,
          companyIDLabel,
          companyID,
          dateOfIncorporation,
          companyType,
          address,
          directors
        };

          document.getElementById("parsedDetails").innerHTML = `
          
            <h2>Parsed Company Details:</h2>

            <div class="editable-row">
              <label>Company Name:</label>
              <input type="text" id="COMPANY_NAME" class="editable-field" value="${parsedData.companyName || 'Not found'}">
            </div>

            <div class="editable-row">
              <label>${parsedData.companyIDLabel}:</label>
              <input type="text" id="COMPANY_ID" class="editable-field" value="${parsedData.companyID || 'Not found'}">
              <input type="text" id="ID_1" class="editable-field" value="${parsedData.companyIDLabel || 'Not found'}" hidden>
            </div>

            <div class="editable-row">
              <label>Date of Incorporation:</label>
              <input type="text" id="DATE_OF_INCORPORATION" class="editable-field" value="${parsedData.dateOfIncorporation || 'Not found'}">
            </div>

            <div class="editable-row">
              <label>Company Type:</label>
              <input type="text" id="COMPANY_TYPE" class="editable-field" value="${parsedData.companyType || 'Not found'}">
            </div>

            <div class="editable-row">
              <label>Address:</label>
              <textarea id="ADDRESS" class="editable-field" rows="3">${parsedData.address || 'Not found'}</textarea>
            </div>

            <div class="editable-row">
              <label>Email:</label>
              <input type="email" id="EMAIL" class="editable-field" placeholder="Enter email" required>
            </div>

            <div class="editable-row">
              <label>Phone Num:</label>
              <input type="text" id="PHONE_1" class="editable-field" placeholder="Enter Phone Num" required>
            </div>

            <div class="editable-row">
              <label>Date:</label>
              <input type="text" id="DATE" class="editable-field" placeholder="DD-MM-YYYY" maxlength="10" required>
            </div>

            <div class="editable-row">
              <label>DEED DATE:</label>
              <input type="text" id="DEED_DATE" class="editable-field" placeholder="06th day of January, 2025" readonly>
            </div>

            <div class="editable-row">
              <label>Day:</label>
              <input type="text" id="DAY" class="editable-field" placeholder="Sunday" required>
            </div>

            <h3>Directors:</h3>
            ${parsedData.directors.map((d, i) => `
              <div class="director-box" data-index="${i}">
                <div class="editable-row">
                  <label>Name:</label>
                  <input type="text" id="PERSON_${i+1}" class="editable-field director-name" value="${d.name}">
                </div>
                <div class="editable-row">
                  <label>Designation:</label>
                  <input type="text" id="PERSON_${i+1}_D" class="editable-field director-designation" value="${d.designation}">
                </div>
                <div class="editable-row">
                  <label>DIN:</label>
                  <input type="text" id="PERSON_${i+1}_DIN" class="editable-field director-din" value="${d.din}">
                </div>
              </div>
            `).join('')}
            <br>
            <button id="convert" disabled>Convert to Word</button>
          `;
function formatDateForDeed(dateString) {
  const [day, month, year] = dateString.split('-').map(Number);
  const date = new Date(year, month - 1, day);

  const daySuffix = (d) => {
    if (d > 3 && d < 21) return 'th';
    switch (d % 10) {
      case 1: return 'st';
      case 2: return 'nd';
      case 3: return 'rd';
      default: return 'th';
    }
  };

  const monthNames = [
    "January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"
  ];

  return `${date.getDate()}${daySuffix(date.getDate())} day of ${monthNames[date.getMonth()]}, ${date.getFullYear()}`;
}

document.getElementById('DATE').addEventListener('input', function(e) {
  let value = e.target.value.replace(/\D/g, ''); // remove non-digits

  // Auto insert dashes
  if (value.length > 2 && value.length <= 4) {
    value = value.slice(0, 2) + '-' + value.slice(2);
  } else if (value.length > 4) {
    value = value.slice(0, 2) + '-' + value.slice(2, 4) + '-' + value.slice(4, 8);
  }
  e.target.value = value;

  let parts = value.split('-');
  let dayField = document.getElementById('DAY');
  let deedDateField = document.getElementById('DEED_DATE'); // hidden field

  dayField.value = ''; // reset
  deedDateField.value = ''; // reset
  e.target.style.backgroundColor = ''; // reset

  // Validate
  if (parts.length === 3 && parts[0].length === 2 && parts[1].length === 2 && parts[2].length === 4) {
    let day = parseInt(parts[0], 10);
    let month = parseInt(parts[1], 10);
    let year = parseInt(parts[2], 10);

    if (month > 12 || day > 31 || year < 1900 || year > 2100) {
      e.target.style.backgroundColor = '#66ac4c40'; // invalid
      return;
    }

    // Generate Day of Week
    let dateObj = new Date(year, month - 1, day);
    if (!isNaN(dateObj)) {
      let days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      dayField.value = days[dateObj.getDay()];

      // Generate Deed Date format
      deedDateField.value = formatDateForDeed(value);
    }
  }
});


          // Enable convert button only if all required fields are filled
          const requiredFields = document.querySelectorAll("#parsedDetails [required]");
          const convert = document.getElementById("convert");

          function checkRequiredFields() {
            let allFilled = true;
            requiredFields.forEach(field => {
              if (!field.value.trim()) {
                allFilled = false;
              }
            });
            convert.disabled = !allFilled;
          }

          requiredFields.forEach(field => {
            field.addEventListener("input", checkRequiredFields);
          });

          checkRequiredFields();

          convert.addEventListener("click", handleConvertClick);
      } catch (err) {
        console.error(err);
        if (rafId) cancelAnimationFrame(rafId);
        loadingWrapper.style.display = "none";
        loadingBar.style.width = "0%";
        if (loadingPercent) loadingPercent.textContent = "0%";
        if (loadingLabel) loadingLabel.textContent = "Fetching company data…";
      }
    }

    async function handleConvertClick() {
      const directors = [];
      document.querySelectorAll(".director-box").forEach((box, i) => {
        const idx = i + 1;
        const name = document.getElementById(`PERSON_${idx}`)?.value || "";
        const designation = document.getElementById(`PERSON_${idx}_D`)?.value || "";
        const din = document.getElementById(`PERSON_${idx}_DIN`)?.value || "";
        directors.push({ name, designation, din });
      });

      const replacements = {
        page: "GST Resolution",
        COMPANY_NAME: document.getElementById("COMPANY_NAME").value,
        COMPANY_ID: document.getElementById("COMPANY_ID").value,
        ID_1: document.getElementById("ID_1").value,
        DATE_OF_INCORPORATION: document.getElementById("DATE_OF_INCORPORATION").value,
        COMPANY_TYPE: document.getElementById("COMPANY_TYPE").value,
        ADDRESS: document.getElementById("ADDRESS").value,
        EMAIL: document.getElementById("EMAIL").value,
        PHONE_1: document.getElementById("PHONE_1").value,
        DATE: document.getElementById("DATE").value,
        DAY: document.getElementById("DAY").value,
        DEED_DATE: document.getElementById("DEED_DATE").value,
        directors
      };

      try {
        const res = await fetch("/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(replacements)
        });

        if (!res.ok) return;

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${document.getElementById("COMPANY_NAME").value} Resolution.docx`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error(err);
      }
    }
  </script>
  <a href="https://www.on-tym.solutions/" target="_blank" rel="noopener noreferrer">
    <img src="/Ontym.png" alt="On-tym Logo" class="fixed-bottom-logo" />
  </a>
</body>
</html>
