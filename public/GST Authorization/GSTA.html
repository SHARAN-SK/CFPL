<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GST Registration - Compliance First</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .loading-wrapper { display: none; margin: 10px 0 16px 0; }
    .loading-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; color: #2e7d32; font-weight: 600; font-size: 13px; letter-spacing: 0.2px; }
    .loading-track { position: relative; width: 100%; height: 8px; background: rgba(76, 175, 80, 0.15); border-radius: 999px; overflow: hidden; box-shadow: inset 0 0 0 1px rgba(46, 125, 50, 0.12); }
    .loading-bar { position: absolute; left: 0; top: 0; bottom: 0; width: 0%; border-radius: 999px; background-image: linear-gradient(90deg, #43a047, #66bb6a); box-shadow: 0 0 12px rgba(102, 187, 106, 0.6); transition: width 0.25s ease; }
    .loading-bar::after { content: ""; position: absolute; inset: 0; background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.25) 0, rgba(255,255,255,0.25) 10px, transparent 10px, transparent 20px); background-size: 28px 28px; animation: barberpole 0.9s linear infinite; border-radius: inherit; }
    @keyframes barberpole { 0% { background-position: 0 0; } 100% { background-position: 28px 0; } }
  </style>
</head>
<body>
  <div class="background"></div>
  <a href="#" class="home-btn" onclick="event.preventDefault(); history.back();">← BACK</a>
  <header>
    <img src="logo.png" alt="Logo" class="logo"/>
    <h1 class="company-name">GST Authorization</h1>
  </header>

  <main>
    <div id="fetchSection" class="fetch-container">
      <div class="input-and-buttons">
        <label for="company">Enter Company Name:</label>
        <input type="text" id="company" class="uppercase-input" placeholder="e.g. Compliance First Pvt. Ltd" />
        <div class="fetch-buttons-group">
          <button id="parseBtn1" onclick="parseResponseMCA()">MCA Fetch</button>
          <button id="parseBtn" onclick="parseResponseFalcon()">Falcon Fetch</button>
        </div>
      </div>
      <div id="loadingWrapper" class="loading-wrapper">
        <div class="loading-header">
          <span id="loadingLabel">Fetching company data…</span>
          <span id="loadingPercent">0%</span>
        </div>
        <div class="loading-track">
          <div id="loadingBar" class="loading-bar"></div>
        </div>
      </div>
      <div id="parsedDetails" style="margin-top: 0px;"></div>
    </div>

    <!-- Directors section OUTSIDE fetch container -->
    <div id="directorsSection"></div>
  </main>
  
  <!-- Custom Alert Modal -->
  <div id="customAlert" class="custom-alert">
    <div class="custom-alert-content">
      <span id="customAlertMsg"></span>
      <button onclick="closeCustomAlert()">OK</button>
    </div>
  </div>

  <script>
    /** -----------------------
     * Custom Alert Functions
     ------------------------*/
    function showCustomAlert(message) {
      document.getElementById("customAlertMsg").innerHTML = message;
      document.getElementById("customAlert").style.display = "flex";
    }

    function closeCustomAlert() {
      document.getElementById("customAlert").style.display = "none";
    }

    // Auto-uppercase utility for inputs with class 'uppercase-input'
    function addUppercaseListeners(root = document) {
      const fields = root.querySelectorAll('.uppercase-input');
      fields.forEach((field) => {
        const toUpper = () => {
          if (typeof field.value === 'string') field.value = field.value.toUpperCase();
        };
        field.removeEventListener('input', toUpper);
        field.addEventListener('input', toUpper);
        field.removeEventListener('blur', toUpper);
        field.addEventListener('blur', toUpper);
      });
    }
    document.addEventListener('DOMContentLoaded', function(){ addUppercaseListeners(document); });

    // MCA Fetch Function
    async function parseResponseMCA() {
      await parseResponse('/api/mca-fetch');
    }

    // Falcon Fetch Function  
    async function parseResponseFalcon() {
      await parseResponse('/api/falcon-fetch');
    }

    async function parseResponse(apiEndpoint = '/api/getdata') {
      const companyInput = document.getElementById("company");
      const company = companyInput.value.trim();
      
      if (!company) {
        showCustomAlert("⚠️ Please enter a company name.");
        return;
      }

      const loadingWrapper = document.getElementById("loadingWrapper");
      const loadingBar = document.getElementById("loadingBar");
      const loadingPercent = document.getElementById("loadingPercent");
      const loadingLabel = document.getElementById("loadingLabel");
      loadingWrapper.style.display = "block";
      loadingBar.style.width = "0%";
      if (loadingPercent) loadingPercent.textContent = "0%";
      if (loadingLabel) loadingLabel.textContent = "Fetching company data…";

      // Smooth animated progress using requestAnimationFrame
      let progress = 0;
      let rafId = null;
      const animate = () => {
        // Ease towards 95%
        progress += (95 - progress) * 0.05;
        if (progress > 95) progress = 95;
        loadingBar.style.width = progress + "%";
        if (loadingPercent) loadingPercent.textContent = Math.round(progress) + "%";
        rafId = requestAnimationFrame(animate);
      };
      rafId = requestAnimationFrame(animate);

      try {
        const response = await fetch(`${apiEndpoint}?name=${encodeURIComponent(company)}`);
        const result = await response.json();

        if (rafId) cancelAnimationFrame(rafId);
        loadingBar.style.width = "100%";
        if (loadingPercent) loadingPercent.textContent = "100%";
        if (loadingLabel) loadingLabel.textContent = "Finalizing…";
        setTimeout(() => {
          loadingWrapper.style.display = "none";
          loadingBar.style.width = "0%";
          if (loadingPercent) loadingPercent.textContent = "0%";
          if (loadingLabel) loadingLabel.textContent = "Fetching company data…";
        }, 300);

        const d = result.data || {};
        const haveCIN = !!d.CIN;
        const companyIDLabel = haveCIN ? "CIN" : "LLPIN";
        const companyID = haveCIN ? (d.CIN || "") : (d.LLPIN || "");
        const directors = Array.isArray(d.Directors) && d.Directors.length ? d.Directors : [{}, {}];

        document.getElementById("parsedDetails").innerHTML = `
            <h2>Parsed Company Details:</h2>

            <div class=\"editable-row\">
              <label>Company Name:</label>
              <input type=\"text\" id=\"COMPANY_NAME\" class=\"editable-field\" value=\"${company || 'Not found'}\">
            </div>

            <div class=\"editable-row\">
              <label>${companyIDLabel}:</label>
              <input type=\"text\" id=\"COMPANY_ID\" class=\"editable-field\" value=\"${companyID || 'Not found'}\">
            </div>

            <div class=\"editable-row\">
              <label>ADDRESS:</label>
              <textarea id=\"ADDRESS\" class=\"editable-field\" rows=\"3\">${d.Address || 'Not found'}<\/textarea>
            </div>

            <div class=\"editable-row\">
              <label>DATE:</label>
              <input type=\"text\" id=\"DATE\" class=\"editable-field\" placeholder=\"DD-MM-YYYY\" maxlength=\"10\" required>
            </div>

            <div class=\"editable-row\">
              <label>PLACE:</label>
              <input type=\"text\" id=\"PLACE\" class=\"editable-field\" placeholder=\"eg: Salem\" required>
            </div>
        `;

        document.getElementById("directorsSection").innerHTML = `
  <div class="director-controls">
    <h2>Director Details</h2>
    <button onclick="addDirector()">+ Add Director</button>
  </div>
  <div class="fetch-container1">
    ${directors.map((dir, i) => `
      <div class="director-box1" style="margin-top: 10px;" data-index="${i+1}">
        <div class="box-header">
          <h4>Director ${i+1}</h4>
          <button class="remove-btn" onclick="removeDirector(this)">Remove</button>
        </div>
        <div class="editable-row">
          <label>NAME:</label>
          <input type="text" id="PERSON_${i+1}" class="editable-field uppercase-input" value="${(dir.Name||'').toString()}">
        </div>
        <div class="editable-row">
          <label>Designation:</label>
          <input type="text" id="PERSON_${i+1}_D" class="editable-field" value="${(dir.Designation||'').toString()}">
        </div>
        <div class="editable-row">
          <label>DIN:</label>
          <input type="text" id="PERSON_${i+1}_DIN" class="editable-field" value="${(dir.DIN||'').toString()}">
        </div>
      </div>
    `).join('')}
  </div>
  
  <div class="button-center">
    <button id="convert" disabled>Convert to Word</button>
  </div>
`;

        window.removeDirector = function(button) {
          const directorBox = button.closest('.director-box1');
          if (directorBox) {
              directorBox.remove();
          }
        }

        window.addDirector = function() {
          const container = document.querySelector('.fetch-container1');
          const existingDirectors = container.querySelectorAll('.director-box1');
          const newIndex = existingDirectors.length + 1;
          
          const newDirectorHTML = `
            <div class="director-box1" style="margin-top: 10px;" data-index="${newIndex}">
              <div class="box-header">
                <h4>Director ${newIndex}</h4>
                <button class="remove-btn" onclick="removeDirector(this)">Remove</button>
              </div>
              <div class="editable-row">
                <label>NAME:</label>
                <input type="text" id="PERSON_${newIndex}" class="editable-field uppercase-input" value="">
              </div>
              <div class="editable-row">
                <label>Designation:</label>
                <input type="text" id="PERSON_${newIndex}_D" class="editable-field" value="">
              </div>
              <div class="editable-row">
                <label>DIN:</label>
                <input type="text" id="PERSON_${newIndex}_DIN" class="editable-field" value="">
              </div>
            </div>
          `;
          
          container.insertAdjacentHTML('beforeend', newDirectorHTML);
          
          // Re-attach uppercase listeners to new fields
          addUppercaseListeners(document);
        }

        document.getElementById('DATE').addEventListener('input', function(e) {
          let value = e.target.value.replace(/\D/g, '');
          if (value.length > 2 && value.length <= 4) {
            value = value.slice(0, 2) + '-' + value.slice(2);
          } else if (value.length > 4) {
            value = value.slice(0, 2) + '-' + value.slice(2, 4) + '-' + value.slice(4, 8);
          }
          e.target.value = value;

          let parts = value.split('-');
          e.target.style.backgroundColor = '';

          if (parts.length === 3 && parts[0].length === 2 && parts[1].length === 2 && parts[2].length === 4) {
            let day = parseInt(parts[0], 10);
            let month = parseInt(parts[1], 10);
            let year = parseInt(parts[2], 10);

            if (month > 12 || day > 31 || year < 1900 || year > 2100) {
              e.target.style.backgroundColor = '#66ac4c40';
              return;
            }
          }
        });

        const requiredFields = document.querySelectorAll("#parsedDetails [required]");
        const convert = document.getElementById("convert");
        function checkRequiredFields() {
          let allFilled = true;
          requiredFields.forEach(field => {
            if (!field.value.trim()) {
              allFilled = false;
            }
          });
          convert.disabled = !allFilled;
        }
        requiredFields.forEach(field => field.addEventListener("input", checkRequiredFields));
        checkRequiredFields();
        convert.addEventListener("click", handleConvertClick);

      } catch (err) {
        console.error(err);
        if (rafId) cancelAnimationFrame(rafId);
        loadingWrapper.style.display = "none";
        loadingBar.style.width = "0%";
        if (loadingPercent) loadingPercent.textContent = "0%";
        if (loadingLabel) loadingLabel.textContent = "Fetching company data…";
        showCustomAlert("❌ Error fetching company data: " + err.message);
      }
    }

    async function handleConvertClick() {
      const directors = [];
      document.querySelectorAll(".director-box1").forEach((box, i) => {
        const idx = i + 1;
        directors.push({
          name: document.getElementById(`PERSON_${idx}`)?.value || "",
          designation: document.getElementById(`PERSON_${idx}_D`)?.value || "",
          din: document.getElementById(`PERSON_${idx}_DIN`)?.value || ""
        });
      });

      const replacements = {
        page: "GST Authorization",
        COMPANY_NAME: document.getElementById("COMPANY_NAME")?.value || "",
        COMPANY_ID: document.getElementById("COMPANY_ID")?.value || "",
        ADDRESS: document.getElementById("ADDRESS")?.value || "",
        PLACE: document.getElementById("PLACE")?.value || "",
        DATE: document.getElementById("DATE")?.value || "",
        directors
      };

      try {
        const res = await fetch("/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(replacements)
        });

        if (!res.ok) return;
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${document.getElementById("COMPANY_NAME").value} Authorization.docx`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error(err);
      }
    }
  </script>
  <img src="/Ontym.png" alt="On-tym Logo" class="fixed-bottom-logo" />
</body>
</html>
